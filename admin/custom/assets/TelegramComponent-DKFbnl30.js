import{j as s,L as m,P as _,T as p,H as f,G as c,F as a,J as u,C as x,I as g,D as C}from"./Delete-PhF3iX4Z.js";import{C as o,T as S}from"./ConfigCustomTelegramSet__loadShare___mf_0_iobroker_mf_1_adapter_mf_2_react_mf_2_v5__loadShare__-BSDpFH9S.js";import{C as j,i as v}from"./ConfigCustomTelegramSet__mf_v__runtimeInit__mf_v__-_xfUaItO.js";const{loadShare:y}=v,{initPromise:T}=j,I=T.then(l=>y("@iobroker/json-config",{customShareInfo:{shareConfig:{singleton:!0,strictVersion:!1,requiredVersion:"*"}}})),k=await I.then(l=>l());var b=k;class N extends b.ConfigGeneric{constructor(e){super(e),this.state={...this.state,alive:!1,initialized:!1,users:[],confirm:null}}componentDidMount(){super.componentDidMount(),this.props.oContext.socket.getState(`system.adapter.telegram.${this.props.oContext.instance}.alive`).then(async e=>{e&&e.val?this.setState({alive:!0},()=>this.readData()):this.setState({alive:!1}),await this.props.oContext.socket.subscribeState(`system.adapter.telegram.${this.props.oContext.instance}.alive`,this.onAliveChanged)})}readData(){this.props.oContext.socket.sendTo(`telegram.${this.props.oContext.instance}`,"adminuser",null).then(e=>{const i=[];for(const t in e){const n=[];e[t].userName&&n.push(e[t].userName),e[t].firstName&&n.push(e[t].firstName),i.push({id:t,names:n.join(" / "),sysMessages:e[t].sysMessages})}this.setState({users:i,initialized:!0})})}async componentWillUnmount(){await this.props.oContext.socket.unsubscribeState(`system.adapter.telegram.${this.props.oContext.instance}.alive`,this.onAliveChanged)}onAliveChanged=(e,i)=>{const t=i?i.val:!1;t!==this.state.alive&&this.setState({alive:t},()=>{t&&!this.state.initialized&&this.readData()})};onSysMessageChange(e){const i=this.state.users.findIndex(t=>t.id===e);if(i!==-1){const t=!this.state.users[i].sysMessages;this.props.oContext.socket.sendTo(`telegram.${this.props.oContext.instance}`,"systemMessages",{itemId:e,checked:t}).then(n=>{if(n===e){const r=JSON.parse(JSON.stringify(this.state.users)),h=r.findIndex(d=>d.id===e);h!==-1&&(r[h].sysMessages=t,this.setState({users:r}))}})}}onDelete(e){this.props.oContext.socket.sendTo(`telegram.${this.props.oContext.instance}`,"delUser",e).then(i=>{if(i===e){const t=JSON.parse(JSON.stringify(this.state.users)),n=t.findIndex(r=>r.id===e);n!==-1&&(t.splice(n,1),this.setState({users:t}))}})}renderConfirmDialog(){return this.state.confirm?s.jsx(o.Confirm,{onClose:e=>{const i=this.state.confirm;this.setState({confirm:null},()=>e&&this.onDelete(i))}}):null}renderItem(){return!this.state.alive&&!this.state.initialized?s.jsx("div",{children:o.I18n.t("custom_telegram_not_alive")}):this.state.initialized?s.jsxs("div",{style:{width:"100%"},children:[s.jsx("h4",{children:o.I18n.t("custom_telegram_title")}),s.jsx(S,{component:_,style:{width:"100%"},children:s.jsxs(p,{style:{width:"100%"},size:"small",children:[s.jsx(f,{children:s.jsxs(c,{children:[s.jsx(a,{children:o.I18n.t("custom_telegram_id")}),s.jsx(a,{children:o.I18n.t("custom_telegram_name")}),s.jsx(a,{children:o.I18n.t("custom_telegram_sys_messages")}),s.jsx(a,{})]})}),s.jsx(u,{children:this.state.users.map(e=>s.jsxs(c,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[s.jsx(a,{component:"th",scope:"row",children:e.id}),s.jsx(a,{children:e.names}),s.jsx(a,{children:s.jsx(x,{disabled:!this.state.alive,checked:!!e.sysMessages,onClick:()=>this.onSysMessageChange(e.id)})}),s.jsx(a,{children:s.jsx(g,{disabled:!this.state.alive,onClick:()=>this.setState({confirm:e.id}),children:s.jsx(C,{})})})]},e.id))})]})}),this.renderConfirmDialog()]}):s.jsx(m,{})}}export{N as T};
